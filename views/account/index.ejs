<!DOCTYPE html>
<html lang="tr">
<%- include('../partials/shop-head', { title: 'Hesabım' }) %>
<body>
  <%- include('../partials/shop-header') %>
  <main class="page">
    <% const activeList = activeOrders || []; %>
    <% const pastList = pastOrders || []; %>
    <section class="container">
      <div class="account-card">
        <header>
          <h1>Merhaba, <%= currentUser.name %></h1>
          <p>Hesap bilgilerinizi yönetip siparişlerinizi takip edebilirsiniz.</p>
        </header>
        <div class="account-summary">
          <div>
            <span>E-posta</span>
            <strong><%= currentUser.email %></strong>
          </div>
          <div>
            <span>Telefon</span>
            <strong><%= currentUser.phone || '—' %></strong>
          </div>
          <div>
            <span>Sipariş Sayısı</span>
            <strong><%= activeList.length + pastList.length %></strong>
          </div>
        </div>
      </div>
    </section>

    <section class="container account-grid">
      <div class="account-panel">
        <h2>Profil Bilgileri</h2>
        <form action="/account/profile" method="POST" class="account-form">
          <label>
            Ad Soyad
            <input name="name" value="<%= currentUser.name %>" required>
          </label>
          <label>
            Telefon
            <input name="phone" value="<%= currentUser.phone || '' %>" placeholder="+90 ...">
          </label>
          <button type="submit" class="btn btn-primary">Bilgileri Güncelle</button>
        </form>
      </div>
      <div class="account-panel">
        <h2>Adreslerim</h2>
        <div class="address-group">
          <h3>Teslimat Adresi</h3>
          <form action="/account/address" method="POST" class="account-form">
            <input type="hidden" name="type" value="shipping">
            <label>
              Başlık
              <input name="title" value="<%= shippingAddress ? shippingAddress.title : '' %>" placeholder="Ev, Ofis...">
            </label>
            <label>
              Alıcı
              <input name="recipientName" value="<%= shippingAddress ? shippingAddress.recipientName : currentUser.name %>" required>
            </label>
            <label>
              Telefon
              <input name="phone" value="<%= shippingAddress ? shippingAddress.phone : currentUser.phone || '' %>" placeholder="+90 ...">
            </label>
            <label>
              Adres
              <textarea name="addressLine" required><%= shippingAddress ? shippingAddress.addressLine : '' %></textarea>
            </label>
            <label>
              İlçe
              <input name="district" value="<%= shippingAddress ? shippingAddress.district : '' %>">
            </label>
            <label>
              Şehir
              <input name="city" value="<%= shippingAddress ? shippingAddress.city : '' %>" required>
            </label>
            <label>
              Posta Kodu
              <input name="postalCode" value="<%= shippingAddress ? shippingAddress.postalCode : '' %>">
            </label>
            <label>
              Ülke
              <input name="country" value="<%= shippingAddress ? shippingAddress.country : 'Türkiye' %>">
            </label>
            <button type="submit" class="btn btn-primary">Teslimat Adresini Kaydet</button>
          </form>
          <% if (shippingAddress) { %>
            <form action="/account/address?_method=DELETE" method="POST" class="address-delete-form">
              <input type="hidden" name="type" value="shipping">
              <button type="submit" class="btn btn-ghost">Teslimat adresini sil</button>
            </form>
          <% } %>
        </div>
        <div class="address-group">
          <h3>Fatura Adresi</h3>
          <form action="/account/address" method="POST" class="account-form">
            <input type="hidden" name="type" value="billing">
            <label>
              Başlık
              <input name="title" value="<%= billingAddress ? billingAddress.title : '' %>" placeholder="Ev, Ofis...">
            </label>
            <label>
              Alıcı
              <input name="recipientName" value="<%= billingAddress ? billingAddress.recipientName : currentUser.name %>" required>
            </label>
            <label>
              Telefon
              <input name="phone" value="<%= billingAddress ? billingAddress.phone : currentUser.phone || '' %>" placeholder="+90 ...">
            </label>
            <label>
              Adres
              <textarea name="addressLine" required><%= billingAddress ? billingAddress.addressLine : '' %></textarea>
            </label>
            <label>
              İlçe
              <input name="district" value="<%= billingAddress ? billingAddress.district : '' %>">
            </label>
            <label>
              Şehir
              <input name="city" value="<%= billingAddress ? billingAddress.city : '' %>" required>
            </label>
            <label>
              Posta Kodu
              <input name="postalCode" value="<%= billingAddress ? billingAddress.postalCode : '' %>">
            </label>
            <label>
              Ülke
              <input name="country" value="<%= billingAddress ? billingAddress.country : 'Türkiye' %>">
            </label>
            <button type="submit" class="btn btn-primary">Fatura Adresini Kaydet</button>
          </form>
          <% if (billingAddress) { %>
            <form action="/account/address?_method=DELETE" method="POST" class="address-delete-form">
              <input type="hidden" name="type" value="billing">
              <button type="submit" class="btn btn-ghost">Fatura adresini sil</button>
            </form>
          <% } %>
        </div>
      </div>
    </section>

    <section class="container">
      <% const isSubscribed = subscription && subscription.status === 'active'; %>
      <div class="account-card account-card--subscription">
        <header>
          <h2>Tea Lab Aboneliği</h2>
          <p>Her ay 100 g özel harman, öncelikli erişim ve sadece abonelere özel etkinlik davetleri.</p>
        </header>
        <div class="subscription-summary">
          <div>
            <span>Plan</span>
            <strong>Tea Lab Aylık</strong>
          </div>
          <div>
            <span>Aylık Ücret</span>
            <strong><%= teaLabPlan.price.toFixed(2) %> ₺</strong>
          </div>
          <div>
            <span>Gönderim</span>
            <strong>Her ay <%= teaLabPlan.grams %> g özel harman</strong>
          </div>
          <div>
            <span>Durum</span>
            <strong><%= isSubscribed ? 'Aktif' : 'Pasif' %></strong>
          </div>
        </div>
        <div class="subscription-actions">
          <% if (isSubscribed) { %>
            <form action="/subscriptions/cancel" method="POST">
              <button type="submit" class="btn btn-ghost">Aboneliği İptal Et</button>
            </form>
          <% } else { %>
            <form action="/subscriptions" method="POST">
              <button type="submit" class="btn btn-primary btn-lg">Tea Lab'e Katıl</button>
            </form>
          <% } %>
        </div>
        <% if (isSubscribed && subscription.createdAt) { %>
          <p class="subscription-note">Abonelik başlangıcı: <%= new Date(subscription.createdAt).toLocaleDateString('tr-TR') %></p>
        <% } %>
      </div>
    </section>

    <section class="container account-grid">
      <div class="account-panel">
        <h2>Aktif Siparişlerim</h2>
        <% if (activeList.length === 0) { %>
          <div class="empty-state">
            <h3>Aktif siparişiniz bulunmuyor</h3>
            <p>Yeni sipariş oluşturduğunuzda durumu burada görüntülenecek.</p>
            <a class="btn btn-primary" href="/">Alışverişe Başla</a>
          </div>
        <% } else { %>
          <table class="account-table">
            <thead>
              <tr>
                <th>Sipariş No</th>
                <th>Tutar</th>
                <th>Durum</th>
                <th>Tarih</th>
              </tr>
            </thead>
            <tbody>
              <% activeList.forEach(order => { %>
                <% const statusLabels = orderStatusLabels || { processing: 'Sipariş Hazırlanıyor', shipped: 'Sipariş Yolda' }; %>
                <% const statusLabel = statusLabels[order.status] || order.status; %>
                <% const timelineDate = order.shippedAt || order.paidAt || order.createdAt; %>
                <tr>
                  <td><%= order.orderNumber %></td>
                  <td><%= order.totalAmount.toFixed(2) %> ₺</td>
                  <td><%= statusLabel %></td>
                  <td><%= new Date(timelineDate).toLocaleString('tr-TR') %></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        <% } %>
      </div>
      <div class="account-panel">
        <h2>Geçmiş Siparişlerim</h2>
        <% if (pastList.length === 0) { %>
          <div class="empty-state">
            <h3>Henüz geçmiş siparişiniz yok</h3>
            <p>Teslim edilen siparişleriniz bu alanda listelenecek.</p>
          </div>
        <% } else { %>
          <table class="account-table">
            <thead>
              <tr>
                <th>Sipariş No</th>
                <th>Tutar</th>
                <th>Durum</th>
                <th>Tarih</th>
              </tr>
            </thead>
            <tbody>
              <% pastList.forEach(order => { %>
                <% const statusLabels = orderStatusLabels || { delivered: 'Teslim Edildi', failed: 'İptal Edildi' }; %>
                <% const statusLabel = statusLabels[order.status] || order.status; %>
                <% const timelineDate = order.deliveredAt || order.shippedAt || order.paidAt || order.createdAt; %>
                <tr>
                  <td><%= order.orderNumber %></td>
                  <td><%= order.totalAmount.toFixed(2) %> ₺</td>
                  <td><%= statusLabel %></td>
                  <td><%= new Date(timelineDate).toLocaleString('tr-TR') %></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        <% } %>
      </div>

      <div class="account-panel">
        <h2>Karışımlarım</h2>
        <% if (blends.length === 0) { %>
          <div class="empty-state">
            <h3>Henüz karışım oluşturmadınız</h3>
            <p>Favori çaylarınızı harmanlamak için karışım sayfasını ziyaret edin.</p>
            <a class="btn btn-primary" href="/blends/create">Karışımını Oluştur</a>
          </div>
        <% } else { %>
          <table class="account-table">
            <thead>
              <tr>
                <th>Karışım</th>
                <th>Gram</th>
                <th>Durum</th>
              </tr>
            </thead>
            <tbody>
              <% blends.forEach(blend => { %>
                <tr>
                  <td><a href="/blends/<%= blend.id %>"><%= blend.name %></a></td>
                  <td><%= blend.totalGrams %> g</td>
                  <td><%= blend.isShared ? 'Toplulukta' : 'Özel' %></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        <% } %>
      </div>
    </section>
  </main>
  <%- include('../partials/shop-footer') %>
</body>
</html>
