<!DOCTYPE html>
<html lang="tr">
  <%- include('../partials/shop-head', { title: 'Hesabım' }) %>
<body>
  <%- include('../partials/shop-header') %>
  <% const activeList = activeOrders || []; %>
  <% const pastList = pastOrders || []; %>
  <main class="page">
    <section class="container">
      <%- include('../partials/flash') %>
    </section>
    <section class="container">
      <div class="account-card">
        <header>
          <h1>Merhaba, <%= currentUser.name %></h1>
          <p>Hesap bilgilerinizi yönetip siparişlerinizi takip edebilirsiniz.</p>
        </header>
        <div class="account-summary">
          <div>
            <span>E-posta</span>
            <strong><%= currentUser.email %></strong>
          </div>
          <div>
            <span>Telefon</span>
            <strong><%= currentUser.phone || '—' %></strong>
          </div>
          <div>
            <span>Sipariş Sayısı</span>
            <strong><%= activeList.length + pastList.length %></strong>
          </div>
        </div>
      </div>
    </section>

    <section class="container account-grid">
      <div class="account-panel">
        <h2>Profil Bilgileri</h2>
        <form action="/account/profile" method="POST" class="account-form account-form--inline">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <label>
            Ad Soyad
            <input name="name" value="<%= currentUser.name %>" required>
          </label>
          <label>
            Telefon
            <input name="phone" value="<%= currentUser.phone || '' %>" placeholder="+90 ...">
          </label>
          <button type="submit" class="btn btn-primary">Kaydet</button>
        </form>
      </div>
      <div class="account-panel">
        <h2>Adreslerim</h2>
        <div class="address-preview">
          <div>
            <h3>Teslimat</h3>
            <% if (shippingAddress) { %>
              <p>
                <strong><%= shippingAddress.recipientName %></strong><br>
                <%= shippingAddress.addressLine %><br>
                <% if (shippingAddress.district) { %><%= shippingAddress.district %><br><% } %>
                <%= shippingAddress.city %> <%= shippingAddress.postalCode || '' %><br>
                <%= shippingAddress.country %><br>
                <% if (shippingAddress.phone) { %><small>Tel: <%= shippingAddress.phone %></small><% } %>
              </p>
            <% } else { %>
              <p>Henüz kayıtlı teslimat adresiniz yok.</p>
            <% } %>
          </div>
          <div>
            <h3>Fatura</h3>
            <% if (billingAddress) { %>
              <p>
                <strong><%= billingAddress.recipientName %></strong><br>
                <%= billingAddress.addressLine %><br>
                <% if (billingAddress.district) { %><%= billingAddress.district %><br><% } %>
                <%= billingAddress.city %> <%= billingAddress.postalCode || '' %><br>
                <%= billingAddress.country %><br>
                <% if (billingAddress.phone) { %><small>Tel: <%= billingAddress.phone %></small><% } %>
              </p>
            <% } else { %>
              <p>Henüz kayıtlı fatura adresiniz yok.</p>
            <% } %>
          </div>
        </div>
        <div class="address-actions">
          <button type="button" class="btn btn-primary" data-address-modal="shipping">Teslimat Adresi Düzenle</button>
          <button type="button" class="btn btn-ghost" data-address-modal="billing">Fatura Adresi Düzenle</button>
        </div>
      </div>
    </section>

    <section class="container">
      <% const isSubscribed = subscription && subscription.status === 'active'; %>
      <div class="account-card account-card--subscription">
        <header>
          <h2>Tea Lab Aboneliği</h2>
          <p>Her ay 100 g özel harman, öncelikli erişim ve sadece abonelere özel etkinlik davetleri.</p>
        </header>
        <div class="subscription-summary">
          <div>
            <span>Plan</span>
            <strong>Tea Lab Aylık</strong>
          </div>
          <div>
            <span>Aylık Ücret</span>
            <strong><%= teaLabPlan.price.toFixed(2) %> ₺</strong>
          </div>
          <div>
            <span>Gönderim</span>
            <strong>Her ay <%= teaLabPlan.grams %> g özel harman</strong>
          </div>
          <div>
            <span>Durum</span>
            <strong><%= isSubscribed ? 'Aktif' : 'Pasif' %></strong>
          </div>
        </div>
        <div class="subscription-actions">
          <% if (isSubscribed) { %>
            <form action="/subscriptions/cancel" method="POST">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
              <button type="submit" class="btn btn-ghost">Aboneliği İptal Et</button>
            </form>
          <% } else { %>
            <form action="/subscriptions" method="POST">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
              <button type="submit" class="btn btn-primary btn-lg">Tea Lab'e Katıl</button>
            </form>
          <% } %>
        </div>
        <% if (isSubscribed && subscription.createdAt) { %>
          <p class="subscription-note">Abonelik başlangıcı: <%= new Date(subscription.createdAt).toLocaleDateString('tr-TR') %></p>
        <% } %>
      </div>
    </section>

    <section class="container account-grid">
      <div class="account-panel">
        <h2>Aktif Siparişlerim</h2>
        <% if (activeList.length === 0) { %>
          <div class="empty-state">
            <h3>Aktif siparişiniz bulunmuyor</h3>
            <p>Yeni sipariş oluşturduğunuzda durumu burada görüntülenecek.</p>
            <a class="btn btn-primary" href="/">Alışverişe Başla</a>
          </div>
        <% } else { %>
          <table class="account-table">
            <thead>
              <tr>
                <th>Sipariş No</th>
                <th>Tutar</th>
                <th>Durum</th>
                <th>Tarih</th>
              </tr>
            </thead>
            <tbody>
              <% activeList.forEach(order => { %>
                <% const statusLabels = orderStatusLabels || { processing: 'Sipariş Hazırlanıyor', shipped: 'Sipariş Yolda' }; %>
                <% const statusLabel = statusLabels[order.status] || order.status; %>
                <% const timelineDate = order.shippedAt || order.paidAt || order.createdAt; %>
                <tr>
                  <td><%= order.orderNumber %></td>
                  <td><%= order.totalAmount.toFixed(2) %> ₺</td>
                  <td><%= statusLabel %></td>
                  <td><%= new Date(timelineDate).toLocaleString('tr-TR') %></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        <% } %>
      </div>
      <div class="account-panel">
        <h2>Geçmiş Siparişlerim</h2>
        <% if (pastList.length === 0) { %>
          <div class="empty-state">
            <h3>Henüz geçmiş siparişiniz yok</h3>
            <p>Teslim edilen siparişleriniz bu alanda listelenecek.</p>
          </div>
        <% } else { %>
          <table class="account-table">
            <thead>
              <tr>
                <th>Sipariş No</th>
                <th>Tutar</th>
                <th>Durum</th>
                <th>Tarih</th>
              </tr>
            </thead>
            <tbody>
              <% pastList.forEach(order => { %>
                <% const statusLabels = orderStatusLabels || { delivered: 'Teslim Edildi', failed: 'İptal Edildi' }; %>
                <% const statusLabel = statusLabels[order.status] || order.status; %>
                <% const timelineDate = order.deliveredAt || order.shippedAt || order.paidAt || order.createdAt; %>
                <tr>
                  <td><%= order.orderNumber %></td>
                  <td><%= order.totalAmount.toFixed(2) %> ₺</td>
                  <td><%= statusLabel %></td>
                  <td><%= new Date(timelineDate).toLocaleString('tr-TR') %></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        <% } %>
      </div>

      <div class="account-panel">
        <h2>Karışımlarım</h2>
        <% if (blends.length === 0) { %>
          <div class="empty-state">
            <h3>Henüz karışım oluşturmadınız</h3>
            <p>Favori çaylarınızı harmanlamak için karışım sayfasını ziyaret edin.</p>
            <a class="btn btn-primary" href="/blends/create">Karışımını Oluştur</a>
          </div>
        <% } else { %>
          <table class="account-table">
            <thead>
              <tr>
                <th>Karışım</th>
                <th>Gram</th>
                <th>Durum</th>
              </tr>
            </thead>
            <tbody>
              <% blends.forEach(blend => { %>
                <tr>
                  <td><a href="/blends/<%= blend.id %>"><%= blend.name %></a></td>
                  <td><%= blend.totalGrams %> g</td>
                  <td><%= blend.isShared ? 'Toplulukta' : 'Özel' %></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        <% } %>
      </div>
    </section>
  </main>

  <% if (currentUser) { %>
    <div class="address-modal" data-modal="shipping">
      <div class="address-modal__dialog">
        <header>
          <h2>Teslimat Adresini Düzenle</h2>
          <button type="button" class="address-modal__close" data-modal-close>&times;</button>
        </header>
        <form action="/account/address" method="POST" class="account-form">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <input type="hidden" name="type" value="shipping">
          <label>
            Başlık
            <input name="title" value="<%= shippingAddress ? shippingAddress.title : '' %>" placeholder="Ev, Ofis...">
          </label>
          <label>
            Alıcı
            <input name="recipientName" value="<%= shippingAddress ? shippingAddress.recipientName : currentUser.name %>" required>
          </label>
          <label>
            Telefon
            <input name="phone" value="<%= shippingAddress ? shippingAddress.phone : currentUser.phone || '' %>" placeholder="+90 ...">
          </label>
          <label>
            Adres
            <textarea name="addressLine" required><%= shippingAddress ? shippingAddress.addressLine : '' %></textarea>
          </label>
          <label>
            İlçe
            <input name="district" value="<%= shippingAddress ? shippingAddress.district : '' %>">
          </label>
          <label>
            Şehir
            <input name="city" value="<%= shippingAddress ? shippingAddress.city : '' %>" required>
          </label>
          <label>
            Posta Kodu
            <input name="postalCode" value="<%= shippingAddress ? shippingAddress.postalCode : '' %>">
          </label>
          <label>
            Ülke
            <input name="country" value="<%= shippingAddress ? shippingAddress.country : 'Türkiye' %>">
          </label>
          <div class="address-modal__actions">
            <% if (shippingAddress) { %>
              <button formaction="/account/address?_method=DELETE" formmethod="POST" class="btn btn-ghost" name="type" value="shipping">Adresi Sil</button>
            <% } %>
            <button type="submit" class="btn btn-primary">Kaydet</button>
          </div>
        </form>
      </div>
    </div>

    <div class="address-modal" data-modal="billing">
      <div class="address-modal__dialog">
        <header>
          <h2>Fatura Adresini Düzenle</h2>
          <button type="button" class="address-modal__close" data-modal-close>&times;</button>
        </header>
        <form action="/account/address" method="POST" class="account-form">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <input type="hidden" name="type" value="billing">
          <label>
            Başlık
            <input name="title" value="<%= billingAddress ? billingAddress.title : '' %>" placeholder="Ev, Ofis...">
          </label>
          <label>
            Alıcı
            <input name="recipientName" value="<%= billingAddress ? billingAddress.recipientName : currentUser.name %>" required>
          </label>
          <label>
            Telefon
            <input name="phone" value="<%= billingAddress ? billingAddress.phone : currentUser.phone || '' %>" placeholder="+90 ...">
          </label>
          <label>
            Adres
            <textarea name="addressLine" required><%= billingAddress ? billingAddress.addressLine : '' %></textarea>
          </label>
          <label>
            İlçe
            <input name="district" value="<%= billingAddress ? billingAddress.district : '' %>">
          </label>
          <label>
            Şehir
            <input name="city" value="<%= billingAddress ? billingAddress.city : '' %>" required>
          </label>
          <label>
            Posta Kodu
            <input name="postalCode" value="<%= billingAddress ? billingAddress.postalCode : '' %>">
          </label>
          <label>
            Ülke
            <input name="country" value="<%= billingAddress ? billingAddress.country : 'Türkiye' %>">
          </label>
          <div class="address-modal__actions">
            <% if (billingAddress) { %>
              <button formaction="/account/address?_method=DELETE" formmethod="POST" class="btn btn-ghost" name="type" value="billing">Adresi Sil</button>
            <% } %>
            <button type="submit" class="btn btn-primary">Kaydet</button>
          </div>
        </form>
      </div>
    </div>
  <% } %>

  <%- include('../partials/shop-footer') %>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const openButtons = document.querySelectorAll('[data-address-modal]');
      const closeButtons = document.querySelectorAll('[data-modal-close]');
      const modals = document.querySelectorAll('.address-modal');

      function toggleBody(state) {
        if (state) {
          document.body.classList.add('modal-open');
        } else {
          document.body.classList.remove('modal-open');
        }
      }

      openButtons.forEach((button) => {
        button.addEventListener('click', () => {
          const target = button.getAttribute('data-address-modal');
          const modal = document.querySelector(`.address-modal[data-modal="${target}"]`);
          if (modal) {
            modal.classList.add('is-open');
            toggleBody(true);
          }
        });
      });

      closeButtons.forEach((button) => {
        button.addEventListener('click', () => {
          const modal = button.closest('.address-modal');
          if (modal) {
            modal.classList.remove('is-open');
            toggleBody(false);
          }
        });
      });

      modals.forEach((modal) => {
        modal.addEventListener('click', (event) => {
          if (event.target === modal) {
            modal.classList.remove('is-open');
            toggleBody(false);
          }
        });
      });
    });
  </script>
</body>
</html>
