<!DOCTYPE html>
<html lang="tr">
<%- include('../partials/shop-head', { title: null }) %>

  <body>
    <%- include('../partials/shop-header') %>
      <main class="page page-home">
        <!-- Hero Section -->
        <!-- Hero Section (Classic) -->
        <% /* Logic to determine background image */ const highlightProduct=products.length ? products[0] : null; const
          storeBanner=settings.store_banner && settings.store_banner.trim() !=='' ? settings.store_banner : null; /* If
          store banner exists, use it. Else fall back to highlight product image. */ const heroBgImage=storeBanner ||
          (highlightProduct && highlightProduct.imageUrl ? highlightProduct.imageUrl : null); const
          hasBg=Boolean(heroBgImage); %>

          <section class="hero <%= !hasBg ? 'hero-placeholder' : '' %>">
            <% if (hasBg) { %>
              <div class="hero-background">
                <img src="<%= heroBgImage %>" alt="Banner">
              </div>
              <div class="hero-overlay"></div>
              <% } %>

                <div class="hero-container">
                  <div class="hero-content">
                    <% if (settings.hero_eyebrow) { %>
                      <span class="hero-eyebrow">
                        <%= settings.hero_eyebrow %>
                      </span>
                      <% } %>

                        <h1>
                          <%= settings.hero_title %>
                        </h1>

                        <p>
                          <%= settings.hero_subtitle %>
                        </p>

                        <div class="hero-actions">
                          <% if (settings.hero_btn_text && settings.hero_btn_link) { %>
                            <a href="<%= settings.hero_btn_link %>" class="btn btn-primary">
                              <%= settings.hero_btn_text %>
                            </a>
                            <% } %>

                              <% if (settings.hero_btn2_text && settings.hero_btn2_link) { %>
                                <a href="<%= settings.hero_btn2_link %>" class="btn btn-outline">
                                  <%= settings.hero_btn2_text %>
                                </a>
                                <% } %>
                        </div>
                  </div>
                </div>
          </section>

          <!-- Collection Section -->

          <section id="collection" class="section section-collection">
            <div class="container section-header">
              <div>
                <span class="eyebrow">
                  <%= settings.collection_eyebrow %>
                </span>
                <h2>
                  <%= settings.collection_title %>
                </h2>
              </div>
              <p>
                <%= settings.collection_desc %>
              </p>
            </div>
            <div class="container">
              <form id="filter-form" class="filter-bar">
                <div class="filter-group">
                  <select name="category" id="filter-category">
                    <option value="">Tüm Kategoriler</option>
                    <% categories.forEach(cat=> { %>
                      <option value="<%= cat %>" <%=filters.category===cat ? 'selected' : '' %>><%= cat %>
                      </option>
                      <% }) %>
                  </select>
                </div>

                <div class="filter-group">
                  <select name="sort" id="filter-sort">
                    <option value="date_desc" <%=filters.sort==='date_desc' ? 'selected' : '' %>>En Yeniler</option>
                    <option value="date_asc" <%=filters.sort==='date_asc' ? 'selected' : '' %>>En Eskiler</option>
                    <option value="price_asc" <%=filters.sort==='price_asc' ? 'selected' : '' %>>Fiyat Artan</option>
                    <option value="price_desc" <%=filters.sort==='price_desc' ? 'selected' : '' %>>Fiyat Azalan
                    </option>
                  </select>
                </div>
                <div class="filter-actions">
                  <button type="button" id="filter-btn" class="btn btn-outline btn-sm">Filtrele</button>
                  <a href="#" id="filter-clear" class="btn btn-link btn-sm"
                    style="<%= (filters.category || filters.sort !=='date_desc') ? '' : 'display:none;' %>">Temizle</a>
                </div>
              </form>

              <% if (products.length===0) { %>
                <div class="empty-state">
                  <h3>Sonuç bulunamadı</h3>
                  <p>Seçtiğiniz kriterlere uygun ürün yok veya koleksiyon henüz hazır değil.</p>
                  <% if (filters.category || filters.min_price || filters.max_price) { %>
                    <a href="/" class="btn btn-link">Tüm ürünleri göster</a>
                    <% } %>
                </div>
                <% } else { %>
                  <% const
                    fallbackImage='https://images.unsplash.com/photo-1466978913421-dad2ebd01d17?auto=format&fit=crop&w=1200&q=80'
                    ; %>
                    <div id="products" class="collection-board" role="list">
                      <% products.forEach((product, index)=> { const imageUrl = product.imageUrl &&
                        product.imageUrl.trim() !== '' ? product.imageUrl : fallbackImage; %>
                        <article class="collection-tile" role="listitem" style="--tile-image: url('<%= imageUrl %>');">
                          <header class="collection-tile__header">
                            <span class="collection-tile__index">No.<%= String(index + 1).padStart(2, '0' ) %></span>
                            <span class="collection-tile__price">
                              <%= product.price.toFixed(2) %> ₺
                            </span>
                          </header>
                          <figure class="collection-tile__media">
                            <img src="<%= imageUrl %>" alt="<%= product.name %>" loading="lazy">
                          </figure>
                          <div class="collection-tile__body">
                            <h3 class="collection-tile__title"><a href="/product/<%= product.slug %>">
                                <%= product.name %>
                              </a></h3>
                            <p class="collection-tile__description">
                              <strong>
                                <%= product.grams %> g
                              </strong> &bull; <%= product.description %>
                            </p>
                          </div>
                          <div class="collection-tile__actions">
                            <form action="/cart/add" method="POST">
                              <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                              <input type="hidden" name="productId" value="<%= product.id %>">
                              <button type="submit" class="btn btn-primary">Sepete Ekle</button>
                            </form>
                            <a class="btn btn-ghost" href="/product/<%= product.slug %>">Detaylar</a>
                          </div>
                        </article>
                        <% }) %>
                    </div>
                    <% } %>
            </div>
          </section>


          <!-- Experience Section -->
          <section class="section section-experience">
            <div class="container experience-grid">
              <div>
                <span class="eyebrow">
                  <%= settings.exp_eyebrow %>
                </span>
                <h2>
                  <%= settings.exp_title %>
                </h2>
                <p>
                  <%= settings.exp_desc %>
                </p>
              </div>
              <ul class="experience-points">
                <li>
                  <span>01</span>
                  <div>
                    <h4>
                      <%= settings.exp_p1_title %>
                    </h4>
                    <p>
                      <%= settings.exp_p1_desc %>
                    </p>
                  </div>
                </li>
                <li>
                  <span>02</span>
                  <div>
                    <h4>
                      <%= settings.exp_p2_title %>
                    </h4>
                    <p>
                      <%= settings.exp_p2_desc %>
                    </p>
                  </div>
                </li>
                <li>
                  <span>03</span>
                  <div>
                    <h4>
                      <%= settings.exp_p3_title %>
                    </h4>
                    <p>
                      <%= settings.exp_p3_desc %>
                    </p>
                  </div>
                </li>
            </div>
          </section>
      </main>
      <%- include('../partials/shop-footer') %>

        <script>
          // AJAX Product Filtering
          (function () {
            const filterCategory = document.getElementById('filter-category');
            const filterSort = document.getElementById('filter-sort');
            const filterBtn = document.getElementById('filter-btn');
            const clearBtn = document.getElementById('filter-clear');
            const productsContainer = document.getElementById('products');
            const csrfToken = '<%= csrfToken %>';
            const fallbackImage = 'https://images.unsplash.com/photo-1466978913421-dad2ebd01d17?auto=format&fit=crop&w=1200&q=80';

            async function fetchAndRenderProducts() {
              const category = filterCategory.value;
              const sort = filterSort.value;

              const params = new URLSearchParams();
              if (category) params.set('category', category);
              if (sort) params.set('sort', sort);

              try {
                const response = await fetch('/api/products?' + params.toString());
                const data = await response.json();
                renderProducts(data.products);

                // Show/hide clear button
                if (category || sort !== 'date_desc') {
                  clearBtn.style.display = '';
                } else {
                  clearBtn.style.display = 'none';
                }
              } catch (err) {
                console.error('Filter error:', err);
              }
            }

            function renderProducts(products) {
              if (!productsContainer) return;

              if (products.length === 0) {
                productsContainer.innerHTML = `
            <div class="empty-state" style="grid-column: 1 / -1;">
              <h3>Sonuç bulunamadı</h3>
              <p>Seçtiğiniz kriterlere uygun ürün yok.</p>
            </div>
          `;
                return;
              }

              productsContainer.innerHTML = products.map((product, index) => {
                const imageUrl = product.imageUrl && product.imageUrl.trim() !== '' ? product.imageUrl : fallbackImage;
                return `
            <article class="collection-tile" role="listitem" style="--tile-image: url('${imageUrl}');">
              <header class="collection-tile__header">
                <span class="collection-tile__index">No.${String(index + 1).padStart(2, '0')}</span>
                <span class="collection-tile__price">${product.price.toFixed(2)} ₺</span>
              </header>
              <figure class="collection-tile__media">
                <img src="${imageUrl}" alt="${product.name}" loading="lazy">
              </figure>
              <div class="collection-tile__body">
                <h3 class="collection-tile__title"><a href="/product/${product.slug}">${product.name}</a></h3>
                <p class="collection-tile__description">
                  <strong>${product.grams} g</strong> &bull; ${product.description || ''}
                </p>
              </div>
              <div class="collection-tile__actions">
                <form action="/cart/add" method="POST">
                  <input type="hidden" name="_csrf" value="${csrfToken}">
                  <input type="hidden" name="productId" value="${product.id}">
                  <button type="submit" class="btn btn-primary">Sepete Ekle</button>
                </form>
                <a class="btn btn-ghost" href="/product/${product.slug}">Detaylar</a>
              </div>
            </article>
          `;
              }).join('');
            }

            // Event listeners
            filterBtn.addEventListener('click', fetchAndRenderProducts);

            // Also filter on dropdown change (auto-filter)
            filterCategory.addEventListener('change', fetchAndRenderProducts);
            filterSort.addEventListener('change', fetchAndRenderProducts);

            clearBtn.addEventListener('click', function (e) {
              e.preventDefault();
              filterCategory.value = '';
              filterSort.value = 'date_desc';
              fetchAndRenderProducts();
            });
          })();
        </script>
  </body>

</html>